# v1.8.0 Planning Document - "Production Ready + High-Value Features"

**Status:** 🚀 In Progress  
**Target Release:** November 1, 2025 (7 days)  
**Branch:** `feature/v1.8.0`  
**Risk Level:** Medium (Balanced scope)

---

## 🎯 Strategic Goals

### Primary Objectives
1. **Production Readiness** - Replace Azure API stubs with real SDK integration
2. **Enterprise Features** - Ship Azure Monitor Workbooks and Cost Optimization
3. **Code Quality** - Improve test coverage from 55% to 70%+
4. **Developer Experience** - Add authentication helpers and integration tests

### Success Metrics
- ✅ Zero TODO/FIXME stubs remaining for Azure API calls
- ✅ 400+ tests passing (338 current + 62+ new)
- ✅ 70%+ overall test coverage (15% increase)
- ✅ 2 new feature modules (workbooks + cost optimization)
- ✅ Real Azure SDK integration with authentication
- ✅ All CI checks green across Node 18/20/22

---

## 📦 Feature Breakdown

### 1. Azure SDK Integration (Priority: CRITICAL)

#### 1.1 Package Dependencies
```json
{
  "@azure/arm-compute": "^21.0.0",
  "@azure/identity": "^4.0.0",
  "@azure/arm-monitor": "^8.0.0"
}
```

#### 1.2 Files to Modify
- `src/index.ts` - Replace TODOs at lines 333, 345
- `src/azure/` (NEW) - Azure SDK wrapper modules
  - `auth.ts` - Authentication helper (DefaultAzureCredential)
  - `compute.ts` - VM sizes and images retrieval
  - `monitor.ts` - Monitor/Workbooks API wrapper

#### 1.3 Implementation Details

**Authentication Helper:**
```typescript
// src/azure/auth.ts
import { DefaultAzureCredential, TokenCredential } from '@azure/identity';

export class AzureAuthHelper {
  private credential: TokenCredential | null = null;

  public getCredential(): TokenCredential {
    if (!this.credential) {
      this.credential = new DefaultAzureCredential();
    }
    return this.credential;
  }

  public async validateCredentials(): Promise<boolean> {
    // Validate Azure credentials
  }
}
```

**VM Sizes Retrieval:**
```typescript
// src/azure/compute.ts
import { ComputeManagementClient } from '@azure/arm-compute';

export class ComputeHelper {
  private client: ComputeManagementClient;

  constructor(credential: TokenCredential, subscriptionId: string) {
    this.client = new ComputeManagementClient(credential, subscriptionId);
  }

  public async listVmSizes(location: string): Promise<VmSize[]> {
    const sizes = [];
    for await (const size of this.client.virtualMachineSizes.list(location)) {
      sizes.push(size);
    }
    return sizes;
  }

  public async listVmImages(publisher: string, location: string): Promise<VmImage[]> {
    // Real Azure API call
  }
}
```

#### 1.4 CLI Commands Update
Replace stub implementations:
- `azmp vm list-sizes --location <location>` - Real Azure API
- `azmp vm list-images --publisher <publisher>` - Real Azure API
- `azmp vm validate-credentials` (NEW) - Test Azure auth

#### 1.5 Tests Required
- `src/__tests__/azure-integration.test.ts` (25+ tests)
  - Authentication tests (5 tests)
  - VM sizes retrieval tests (8 tests)
  - VM images retrieval tests (8 tests)
  - Error handling tests (4 tests)

**Estimated Effort:** 1-2 days

---

### 2. Azure Monitor Workbooks Module (Priority: HIGH)

#### 2.1 Module Structure
```
src/workbooks/
├── index.ts                    # Main exports
├── templates.ts                # 20 pre-built templates
├── helpers.ts                  # 8 Handlebars helpers
└── __tests__/
    └── workbooks.test.ts       # 30+ tests
```

#### 2.2 Pre-built Templates (20 templates)

**VM Monitoring Templates (8 templates):**
1. `vm-performance-overview` - CPU, memory, disk, network
2. `vm-availability-report` - Uptime, health checks, alerts
3. `vm-security-audit` - Security events, compliance status
4. `vm-cost-analysis` - Resource costs, optimization opportunities
5. `vm-capacity-planning` - Growth trends, scaling recommendations
6. `vm-backup-status` - Backup jobs, restore points
7. `vm-network-traffic` - Ingress/egress, bandwidth utilization
8. `vm-extension-status` - Extension health, version tracking

**Application Templates (6 templates):**
9. `app-performance-apm` - Application performance monitoring
10. `app-user-analytics` - User sessions, page views
11. `app-error-tracking` - Exception rates, error logs
12. `app-dependency-map` - Service dependencies, latency
13. `app-availability-sla` - SLA compliance, downtime tracking
14. `app-custom-metrics` - Custom application metrics

**Infrastructure Templates (6 templates):**
15. `multi-vm-dashboard` - Fleet-wide monitoring
16. `vmss-autoscale-metrics` - Scale set performance
17. `lb-health-monitoring` - Load balancer health
18. `nsg-flow-analysis` - Network security group flows
19. `disaster-recovery-status` - DR readiness, RPO/RTO
20. `compliance-dashboard` - SOC2, HIPAA, PCI-DSS status

#### 2.3 Handlebars Helpers (8 helpers, `workbook:` namespace)

```handlebars
<!-- Create workbook definition -->
{{workbook:definition
  name="vm-performance"
  displayName="VM Performance Dashboard"
  location="eastus"
  category="workbook"
  serializedData=(workbook:template "vm-performance-overview")}}

<!-- Get pre-built template -->
{{workbook:template "vm-availability-report"}}

<!-- Create KQL query widget -->
{{workbook:kqlQuery
  query="Perf | where CounterName == 'Processor Time' | summarize avg(CounterValue) by bin(TimeGenerated, 5m)"
  chartType="line"
  title="CPU Utilization"}}

<!-- Create metrics chart -->
{{workbook:metricsChart
  resourceId="[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
  metricNamespace="Microsoft.Compute/virtualMachines"
  metricName="Percentage CPU"
  aggregation="Average"}}

<!-- Create parameter input -->
{{workbook:parameter
  name="TimeRange"
  type="timeRange"
  displayName="Time Range"
  defaultValue="Last 24 hours"}}

<!-- Create grid widget -->
{{workbook:grid
  query="AzureActivity | summarize count() by OperationName | order by count_ desc"
  title="Top Operations"}}

<!-- Link multiple workbooks -->
{{workbook:link
  workbookId="[resourceId('Microsoft.Insights/workbooks', 'vm-security-audit')]"
  linkText="View Security Audit"}}

<!-- Export workbook -->
{{workbook:export
  workbookId="vm-performance-overview"
  format="json"}}
```

#### 2.4 CLI Commands (3 commands)

```bash
# List available workbook templates
azmp vm workbook list

# Generate workbook from template
azmp vm workbook generate --template vm-performance-overview --output ./workbook.json

# Validate workbook JSON
azmp vm workbook validate --file ./workbook.json
```

#### 2.5 Tests Required
- Template generation tests (20 tests, one per template)
- Helper functionality tests (8 tests)
- CLI command tests (3 tests)

**Estimated Effort:** 2-3 days

---

### 3. Cost Optimization Module (Priority: HIGH)

#### 3.1 Module Structure
```
src/cost/
├── index.ts                    # Main exports
├── analyzer.ts                 # Cost analysis engine
├── recommendations.ts          # Optimization recommendations
├── budgets.ts                  # Budget alert helpers
├── helpers.ts                  # 10 Handlebars helpers
└── __tests__/
    └── cost.test.ts            # 35+ tests
```

#### 3.2 Cost Analysis Features

**Analyzer Capabilities:**
1. **VM Size Cost Comparison** - Compare costs across VM sizes
2. **Reserved Instance Savings** - Calculate RI savings vs pay-as-you-go
3. **Spot Instance Recommendations** - Identify workloads suitable for Spot
4. **Idle Resource Detection** - Find underutilized VMs
5. **Right-sizing Recommendations** - Suggest optimal VM sizes based on metrics
6. **Storage Cost Analysis** - Analyze disk costs, recommend tier changes
7. **Network Cost Analysis** - Identify expensive data transfers
8. **Licensing Cost Optimization** - Azure Hybrid Benefit recommendations

**Budget Alerts:**
1. Cost threshold alerts
2. Anomaly detection
3. Forecast-based alerts
4. Budget consumption tracking

#### 3.3 Handlebars Helpers (10 helpers, `cost:` namespace)

```handlebars
<!-- Calculate VM cost -->
{{cost:calculateVmCost
  vmSize="Standard_D2s_v3"
  region="eastus"
  hours=730
  pricingModel="payg"}}
<!-- Returns: { monthlyCost: 70.08, hourlyCost: 0.096 } -->

<!-- Compare VM size costs -->
{{cost:compareVmSizes
  sizes=(array "Standard_D2s_v3" "Standard_D4s_v3" "Standard_D8s_v3")
  region="eastus"
  hours=730}}
<!-- Returns: Array of cost comparisons -->

<!-- Calculate Reserved Instance savings -->
{{cost:reservedInstanceSavings
  vmSize="Standard_D2s_v3"
  region="eastus"
  term="1year"}}
<!-- Returns: { paygCost: 841, riCost: 588, savings: 253, savingsPercent: 30 } -->

<!-- Recommend right-sizing -->
{{cost:rightSizeRecommendation
  currentSize="Standard_D8s_v3"
  avgCpuPercent=25
  avgMemoryPercent=30}}
<!-- Returns: { recommendedSize: "Standard_D4s_v3", monthlySavings: 140.16 } -->

<!-- Create budget definition -->
{{cost:budgetDefinition
  name="vm-monthly-budget"
  amount=1000
  timeGrain="Monthly"
  startDate="2025-11-01"
  category="Cost"
  notifications=(array
    (object threshold=80 contactEmails=(array "ops@example.com"))
    (object threshold=100 contactEmails=(array "ops@example.com" "cfo@example.com")))}}

<!-- Calculate storage cost -->
{{cost:storageCost
  diskType="Premium_LRS"
  sizeGb=128
  region="eastus"}}
<!-- Returns: { monthlyCost: 19.71, costPerGb: 0.154 } -->

<!-- Estimate Spot instance savings -->
{{cost:spotInstanceSavings
  vmSize="Standard_D2s_v3"
  region="eastus"
  hours=730
  evictionPolicy="Deallocate"}}
<!-- Returns: { paygCost: 70.08, spotCost: 21.02, savings: 49.06, savingsPercent: 70 } -->

<!-- Get Azure Hybrid Benefit savings -->
{{cost:hybridBenefitSavings
  vmSize="Standard_D2s_v3"
  osType="Windows"
  region="eastus"}}
<!-- Returns: { withoutAHB: 96.36, withAHB: 70.08, savings: 26.28 } -->

<!-- Cost forecast -->
{{cost:forecast
  currentMonthlyCost=500
  growthRate=0.05
  months=12}}
<!-- Returns: Array of monthly forecasts -->

<!-- Cost alert template -->
{{cost:alertTemplate
  budgetName="vm-budget"
  threshold=80
  contactEmails=(array "ops@example.com")
  actionGroups=(array "ops-team-ag")}}
```

#### 3.4 CLI Commands (5 commands)

```bash
# Estimate VM costs
azmp vm cost estimate --size Standard_D2s_v3 --region eastus --hours 730

# Compare VM sizes by cost
azmp vm cost compare --sizes Standard_D2s_v3,Standard_D4s_v3 --region eastus

# Calculate Reserved Instance savings
azmp vm cost reserved-savings --size Standard_D2s_v3 --region eastus --term 1year

# Get right-sizing recommendation
azmp vm cost rightsize --current-size Standard_D8s_v3 --cpu-avg 25 --memory-avg 30

# Generate budget alert template
azmp vm cost budget-alert --amount 1000 --threshold 80
```

#### 3.5 Pricing Data Integration

**Strategy:** Embed Azure pricing data (JSON) or use Azure Retail Prices API
- Option A: Static pricing JSON (faster, requires periodic updates)
- Option B: Azure Retail Prices API (real-time, requires network calls)
- **Recommendation:** Start with Option A, add Option B as enhancement

#### 3.6 Tests Required
- Cost calculation tests (10 tests)
- Recommendation engine tests (8 tests)
- Budget alert tests (5 tests)
- Helper functionality tests (10 tests)
- CLI command tests (5 tests)

**Estimated Effort:** 2-3 days

---

### 4. Test Coverage Improvements (Priority: MEDIUM)

#### 4.1 Target Modules

**Low Coverage Modules:**
1. `src/templates/validation` (24.66% → 70%)
   - Add 15+ tests for validation edge cases
   - Test all validation rules
   - Test error messages

2. `src/security` (36.55% → 70%)
   - Add 20+ tests for encryption scenarios
   - Test Trusted Launch combinations
   - Test compliance templates

3. `src/networking` (47.85% → 70%)
   - Add 25+ tests for networking helpers
   - Test NSG rule validation
   - Test subnet calculations

**Coverage Strategy:**
- Write tests for untested branches
- Add edge case tests
- Add integration tests between modules
- Mock external dependencies properly

#### 4.2 New Test Files
- `src/__tests__/validation-coverage.test.ts` (15+ tests)
- `src/__tests__/security-coverage.test.ts` (20+ tests)
- `src/__tests__/networking-coverage.test.ts` (25+ tests)

**Estimated Effort:** 1 day

---

## 📅 Development Timeline (7 days)

### Day 1: Azure SDK Foundation
- ✅ Install Azure SDK packages
- ✅ Create `src/azure/` module (auth, compute, monitor)
- ✅ Write authentication tests
- ✅ Update `src/index.ts` to remove TODOs

**Deliverables:**
- Working authentication helper
- Real Azure API integration for VM operations
- 25+ integration tests

---

### Day 2-3: Azure Monitor Workbooks
- ✅ Create `src/workbooks/` module
- ✅ Implement 20 pre-built templates
- ✅ Create 8 Handlebars helpers
- ✅ Add 3 CLI commands
- ✅ Write 30+ tests

**Deliverables:**
- Complete workbooks module
- 20 production-ready templates
- Documentation (WORKBOOKS.md)

---

### Day 4-5: Cost Optimization
- ✅ Create `src/cost/` module
- ✅ Implement cost analysis engine
- ✅ Create 10 Handlebars helpers
- ✅ Add 5 CLI commands
- ✅ Embed Azure pricing data
- ✅ Write 35+ tests

**Deliverables:**
- Complete cost optimization module
- Real cost calculations
- Documentation (COST_OPTIMIZATION.md)

---

### Day 6: Coverage Improvements
- ✅ Add tests to low-coverage modules
- ✅ Achieve 70%+ overall coverage
- ✅ Fix any failing tests
- ✅ Update existing tests for new SDK integration

**Deliverables:**
- 70%+ test coverage
- 400+ tests passing
- Zero failing tests

---

### Day 7: Documentation & Release
- ✅ Update README.md with new features
- ✅ Create WORKBOOKS.md and COST_OPTIMIZATION.md
- ✅ Update CHANGELOG.md for v1.8.0
- ✅ Create migration guide (if needed)
- ✅ Run full CI pipeline
- ✅ Tag release v1.8.0
- ✅ Publish to npm

**Deliverables:**
- Complete documentation
- Release notes
- npm package published

---

## 🧪 Testing Strategy

### Test Distribution
- **Unit Tests:** 320+ tests (existing + new)
- **Integration Tests:** 60+ tests (Azure SDK, module interactions)
- **CLI Tests:** 20+ tests (command execution)
- **Total:** 400+ tests

### Coverage Targets
| Module | Current | Target | Tests Needed |
|--------|---------|--------|--------------|
| `src/azure` | 0% (new) | 80% | 25 tests |
| `src/workbooks` | 0% (new) | 85% | 30 tests |
| `src/cost` | 0% (new) | 85% | 35 tests |
| `src/templates/validation` | 24.66% | 70% | 15 tests |
| `src/security` | 36.55% | 70% | 20 tests |
| `src/networking` | 47.85% | 70% | 25 tests |
| **Overall** | **55%** | **70%+** | **150 new tests** |

### CI/CD Requirements
- ✅ All 400+ tests passing
- ✅ 70%+ coverage threshold
- ✅ Zero ESLint errors
- ✅ TypeScript compilation clean
- ✅ Tests pass on Node 18/20/22

---

## 📚 Documentation Updates

### New Documentation Files
1. **WORKBOOKS.md** (~400 lines)
   - Overview of workbooks module
   - 20 template descriptions with screenshots
   - Helper usage examples
   - CLI command reference
   - Best practices

2. **COST_OPTIMIZATION.md** (~500 lines)
   - Cost optimization strategies
   - Helper reference with examples
   - CLI command usage
   - Pricing data sources
   - Best practices for cost management

3. **AZURE_SDK_INTEGRATION.md** (~300 lines)
   - Authentication setup
   - SDK usage patterns
   - Error handling
   - Best practices

### Updated Documentation Files
1. **README.md**
   - Add Azure SDK integration section
   - Add Workbooks section (8 helpers)
   - Add Cost Optimization section (10 helpers)
   - Update helper count: 170 → 188 helpers
   - Update CLI count: 44 → 52 commands
   - Update test count: 338 → 400+ tests

2. **CHANGELOG.md**
   - v1.8.0 release notes
   - Breaking changes (if any)
   - Migration guide

---

## 🔧 Package.json Updates

### Version
```json
{
  "version": "1.8.0"
}
```

### New Dependencies
```json
{
  "dependencies": {
    "@azure/arm-compute": "^21.0.0",
    "@azure/identity": "^4.0.0",
    "@azure/arm-monitor": "^8.0.0"
  }
}
```

### Updated Stats in Description
```json
{
  "description": "Comprehensive VM plugin with 188 helpers, 52 CLI commands, Azure SDK integration, Workbooks, and Cost Optimization"
}
```

---

## 🚨 Risk Management

### Technical Risks

**1. Azure SDK Authentication in CI**
- **Risk:** CI tests may fail without Azure credentials
- **Mitigation:** Mock Azure SDK clients in tests, use environment variables for real integration tests
- **Fallback:** Skip Azure SDK tests in CI if credentials not available

**2. Azure Pricing Data Accuracy**
- **Risk:** Embedded pricing data may become outdated
- **Mitigation:** Document pricing data source and update date, provide disclaimer
- **Fallback:** Add Azure Retail Prices API integration in v1.9.0

**3. Coverage Target Miss**
- **Risk:** May not reach 70% coverage in timeline
- **Mitigation:** Prioritize high-value test areas first
- **Fallback:** Accept 65%+ if comprehensive tests are in place

**4. Workbook Template Complexity**
- **Risk:** 20 templates is ambitious for 2-3 days
- **Mitigation:** Start with 10 core templates, add remaining 10 if time permits
- **Fallback:** Ship 10-15 templates in v1.8.0, defer remaining to v1.8.1

### Timeline Risks

**1. Scope Creep**
- **Risk:** Additional feature requests during development
- **Mitigation:** Lock scope on Day 1, defer new requests to v1.9.0
- **Action:** Create BACKLOG.md for future ideas

**2. Testing Takes Longer**
- **Risk:** 150 new tests may take longer than estimated
- **Mitigation:** Write tests incrementally as features are built
- **Fallback:** Extend to 8-9 days if needed

---

## 📈 Success Criteria

### Must Have (Blocker for Release)
- ✅ Zero TODO/FIXME stubs in codebase
- ✅ Azure SDK integration working (auth + VM operations)
- ✅ Workbooks module complete (minimum 10 templates)
- ✅ Cost optimization module complete (all 10 helpers)
- ✅ 65%+ test coverage
- ✅ 380+ tests passing
- ✅ All CI checks green
- ✅ Documentation complete

### Should Have (High Priority)
- ✅ 70%+ test coverage
- ✅ 400+ tests passing
- ✅ All 20 workbook templates
- ✅ Integration tests for Azure SDK
- ✅ WORKBOOKS.md and COST_OPTIMIZATION.md complete

### Nice to Have (Future Enhancement)
- 🔲 Azure Retail Prices API integration (defer to v1.9.0)
- 🔲 Grafana dashboard export (defer to v1.9.0)
- 🔲 Cost anomaly detection ML model (defer to v2.0.0)
- 🔲 Multi-cloud cost comparison (defer to v2.0.0)

---

## 🎯 Post-Release (v1.8.1 - v1.9.0 Ideas)

### v1.8.1 (Patch) - Likely within 1 week
- Bug fixes
- Missing workbook templates (if deferred)
- Documentation improvements
- Pricing data updates

### v1.9.0 (Minor) - ~2 weeks after v1.8.0
- Prometheus/Grafana integration (from Option C)
- Azure Retail Prices API integration
- Advanced cost optimization (anomaly detection)
- Coverage to 80%+

### v2.0.0 (Major) - Q1 2026
- Multi-cloud support (AWS, GCP)
- Machine learning cost forecasting
- Custom workbook builder UI
- Advanced security scanning

---

## 📝 Notes

### Design Decisions
1. **Azure SDK Mocking:** Use `jest.mock()` for SDK clients to avoid requiring real credentials in tests
2. **Pricing Data:** Start with embedded JSON, plan API integration for v1.9.0
3. **Workbook Templates:** Focus on VM-centric templates first, expand to apps/infra as time permits
4. **Cost Helpers:** Prioritize accuracy over speed, cache pricing data in memory

### Open Questions
1. Should we add Azure CLI fallback if SDK fails? (Recommendation: No, keep it pure SDK)
2. Include cost forecasting ML model in v1.8.0? (Recommendation: Defer to v1.9.0)
3. Support multiple Azure subscriptions in cost analysis? (Recommendation: Yes, via subscription parameter)

---

## 🔗 Related Documents

- [DAY7_SUMMARY.md](docs/DAY7_SUMMARY.md) - v1.7.0 completion summary with v1.8.0 ideas
- [DAY7_PLANNING.md](DAY7_PLANNING.md) - Original v1.7.0 planning with v1.8.0 candidates
- [CHANGELOG.md](CHANGELOG.md) - Version history
- [README.md](README.md) - Main documentation

---

**Last Updated:** October 25, 2025  
**Next Review:** October 26, 2025 (Day 2 check-in)  
**Status:** Ready to Begin 🚀
