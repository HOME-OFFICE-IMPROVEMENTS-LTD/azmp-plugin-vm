# Azure Marketplace VM Plugin – v1.11.0 High Availability Cluster Plan

**Author:** Codex AI (with @msalsouri)  
**Target Release:** v1.11.0  
**Status:** Draft  
**Last Updated:** 2025-02-??

> Goal: Deliver end-to-end high availability clustering so marketplace offers can deploy resilient, multi-zone application tiers without manual wiring.

---

## 1. Objectives
- Provide turn-key proximity placement groups (PPGs) for latency-sensitive clusters.
- Automate load balancer configuration (L4/L7) with health probes wired to VM scale set instances.
- Ship health extension recipes so app owners can surface liveliness signals to probes.
- Support multi-zone, autoscaling VM scale sets (VMSS) backing the load balancer.
- Maintain backwards compatibility for single-VM and non-HA deployments.
- Keep provisioning cost controls (v1.10.0) compatible with HA scenarios (e.g., skip auto-shutdown when load balancer probe is active).

---

## 2. Feature Scope Overview

| Area | Deliverables | Notes |
|------|--------------|-------|
| **Proximity Placement Groups** | Helper + template section to create/manage PPGs, CLI command to list supported regions, config flags to opt-in | Reuse existing availability metadata for region validation |
| **Load Balancer Wiring** | ARM snippets + helpers for public/internal load balancers, backend pools, NAT rules, probes, LB SKU selection | Update `src/networking/loadbalancer.ts`, add template fragments |
| **Health Extensions** | Azure Monitor Agent / Custom Script templates to emit probe endpoints, docs for app integration | Ensure Windows + Linux parity |
| **Multi-Zone VMSS** | Extend VMSS helpers to accept zone sets, PPG binding, upgrade policies, autoscale profiles | Align with cost controls (ephemeral disk compatibility) |
| **Configuration Experience** | Example configs (basic HA, internet-facing, internal-only), README/CHANGELOG updates | Provide before/after diffs from v1.10.0 |

Out-of-scope: Application Gateway WAF, Traffic Manager global routing (candidate for v1.12.0).

---

## 3. Architecture Notes

1. **Topology**
   - Frontend load balancer (public or private) spanning zones, mapped to VMSS backend.
   - Optional jumpbox/bastion recommendations remain additive (docs only).
2. **Resource Graph**
   - PPG (conditional) → VMSS (zones[] + orchestration mode) → Load Balancer backend pool membership.
   - Health probes hit custom extension endpoints; fallback to TCP probes if extension disabled.
3. **Template Strategy**
   - Expand `src/templates/mainTemplate.json.hbs` with new partials referenced via feature flags.
   - Introduce partials under `src/templates/partials/ha/` if structure benefits reuse.
4. **Helper Registration**
   - New module `src/highavailability/cluster.ts` or extend existing availability namespace.
   - Provide CLI surfaces for `azmp ha-plan`, `azmp ha-validate`, `azmp ha-examples`.
5. **Compatibility**
   - Default behavior unchanged when HA block absent.
   - Guards to prevent conflicting settings (e.g., single-instance + load balancer).

---

## 4. Work Breakdown Structure

1. **Design & Validation**
   - Confirm supported regions for PPG + zones (Azure docs snapshot).
   - Define configuration schema additions.
2. **Implementation**
   - PPG helpers + CLI.
   - Load balancer enhancements (backend pools, probes, rules).
   - VMSS zone support and autoscale linkage.
   - Health extension scaffolding.
3. **Templates**
   - Update ARM template with conditional sections.
   - Ensure `createUiDefinition` (if present) exposes HA toggles.
4. **Examples & Docs**
   - Add `examples/ha-basic.json`, `examples/ha-private.json`.
   - Expand README, CHANGELOG (upcoming section).
5. **Testing**
   - Unit tests for helpers.
   - Template snapshot tests (VMSS + LB wiring).
   - Integration smoke (deploy to mocked environment / schema validation).

Target velocity: 5–6 focused development days after design approval.

---

## 5. Testing Strategy

- **Unit Tests:** New suites in `src/__tests__/ha-cluster.test.ts` covering helper logic, config validation.
- **Template Snapshot Tests:** Extend existing template generator tests to assert LB + VMSS JSON output.
- **Static Validation:** Use `arm-ttk` or schema validation scripts (already wired in repo).
- **Scenario Testing:** Document manual deployment steps (ppg + vmss + lb), optional automation via GitHub Actions matrix (if available).
- **Regression:** Ensure existing networking and cost optimization tests remain green; add guard tests to prevent auto-shutdown when HA is enabled by default.

---

## 6. Documentation & Release Tasks

- Update `README.md` feature matrix and quickstart.
- Add new section to `CHANGELOG.md` under “Unreleased”.
- Refresh `PROJECT_STATUS.md` / `PROJECT_ROADMAP.md` with v1.11.0 details.
- Prepare GitHub Release template snippet once implementation completes.
- Gather metrics targets (latency improvements, SLA uplift) for marketing copy.

---

## 7. Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Azure resource interdependencies (PPG + zones limitations) | Deployment failures in unsupported regions | Validate region capability via helper before template emission; fallback to zone-only deployment |
| Load balancer + auto-shutdown conflict | Downtime due to VM shutdown | Auto-disable shutdown schedules when HA flag true unless explicitly overridden |
| Template complexity growth | Harder maintenance, merge conflicts | Modularize into partials, maintain thorough tests |
| Test matrix inflation | Longer CI times | Use targeted snapshots, gate full template build in nightly job |

---

## 8. Timeline (Draft)

| Day | Focus |
|-----|-------|
| Day 0 | Finalize design, update schema diagrams |
| Day 1 | PPG helpers + CLI |
| Day 2 | Load balancer + VMSS enhancements |
| Day 3 | Health extensions + autoscale |
| Day 4 | Template integration + examples |
| Day 5 | Testing, documentation, release prep |

Add buffer for validation + partner review (1–2 days).

---

## 9. Approvals & Dependencies

- Confirm with product owner that HA cluster is priority after v1.10.0.
- Await Azure regional capability spreadsheet (if updated).
- Coordinate with DevOps team if CI enhancements required for schema validation.

---

**Ready for feedback.** Once approved, convert to execution tasks and schedule implementation sprint.

