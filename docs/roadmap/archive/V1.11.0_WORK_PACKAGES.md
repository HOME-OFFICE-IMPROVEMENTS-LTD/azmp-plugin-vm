# v1.11.0 High Availability Cluster - Work Packages

**Feature Branch:** `feature/ha-cluster-proximity-placement-load-balancer`  
**Target:** 5-6 focused development days  
**Status:** Ready for implementation

---

## ðŸ“‹ Work Package Tickets

### **WP1: Proximity Placement Groups Foundation**
**Scope:** PPG helpers, CLI validation, regional capability checks  
**Files:** `src/highavailability/ppg.ts`, CLI commands  
**Timeline:** Day 1

**Tasks:**
- [ ] Create `src/highavailability/ppg.ts` helper module
- [ ] Add PPG ARM template snippets with conditional logic
- [ ] Implement `azmp ha check-region <region>` CLI command
- [ ] Add PPG configuration parameters to schema
- [ ] Unit tests for PPG helper functions
- [ ] Regional capability validation (zone + PPG support matrix)

**Acceptance Criteria:**
- CLI command validates region support for PPG + zones
- Template generates correct PPG resource when enabled
- Helper functions provide zone-aware PPG placement logic

---

### **WP2: Load Balancer Wiring & Health Probes**
**Scope:** LB backend pools, NAT rules, health probe configuration  
**Files:** `src/networking/loadbalancer.ts`, template updates  
**Timeline:** Day 2

**Tasks:**
- [ ] Extend `src/networking/loadbalancer.ts` with HA-specific helpers
- [ ] Add load balancer ARM template sections (public/internal)
- [ ] Implement backend pool automation for VMSS
- [ ] Create health probe configuration (HTTPâ†’TCPâ†’None fallback)
- [ ] Add NAT rule helpers for management access
- [ ] Load balancer SKU selection logic (Standard for zones)

**Acceptance Criteria:**
- Load balancer automatically configured with VMSS backend pool
- Health probes support HTTP endpoints with TCP fallback
- Public and internal LB scenarios both supported

---

### **WP3: Multi-Zone VMSS Enhancement**
**Scope:** Zone distribution, autoscale integration, PPG affinity  
**Files:** `src/availability/vmss.ts`, scaling modules  
**Timeline:** Day 3

**Tasks:**
- [ ] Update VMSS helpers for multi-zone deployment
- [ ] Add PPG binding to VMSS configuration
- [ ] Integrate autoscale profiles with zone balancing
- [ ] Ensure ephemeral disk compatibility with zones
- [ ] Add cost optimization guards (disable auto-shutdown for HA)
- [ ] VMSS upgrade policy configuration

**Acceptance Criteria:**
- VMSS deploys across specified availability zones
- PPG affinity maintained when configured
- Auto-shutdown disabled when HA enabled (costOptimized override)

---

### **WP4: Health Extensions & Application Integration**
**Scope:** Health endpoint scaffolding, Windows/Linux parity  
**Files:** `src/extensions/health.ts`, new module  
**Timeline:** Day 3 (parallel with WP3)

**Tasks:**
- [ ] Create `src/extensions/health.ts` module
- [ ] Add Windows health extension templates (Custom Script + HTTP endpoint)
- [ ] Add Linux health extension templates (shell + systemd service)
- [ ] Document application integration patterns
- [ ] Create health check example scripts
- [ ] Wire health extensions to load balancer probes

**Acceptance Criteria:**
- Health extensions expose HTTP endpoints on configurable ports
- Windows and Linux implementations provide feature parity
- Integration documentation for application developers

---

### **WP5: Template Integration & Configuration Schema**
**Scope:** ARM template updates, configuration UX, partials  
**Files:** `src/templates/mainTemplate.json.hbs`, new partials  
**Timeline:** Day 4

**Tasks:**
- [ ] Add HA configuration block to main template
- [ ] Create template partials under `src/templates/partials/ha/`
- [ ] Update configuration schema with HA parameters
- [ ] Add conditional logic for HA vs single-VM scenarios
- [ ] Ensure backward compatibility for existing configs
- [ ] Update `createUiDefinition.json.hbs` if needed

**Acceptance Criteria:**
- Template generates complete HA stack when configured
- Single-VM deployments remain unchanged
- Configuration validation prevents conflicting settings

---

### **WP6: Examples & Documentation**
**Scope:** Example configs, README updates, CLI help  
**Files:** `examples/`, `README.md`, `CHANGELOG.md`  
**Timeline:** Day 4 (parallel with WP5)

**Tasks:**
- [ ] Create `examples/ha-basic.json` (public LB + 3 zones)
- [ ] Create `examples/ha-private.json` (internal LB + PPG)
- [ ] Create `examples/ha-full-stack.json` (HA + cost optimization)
- [ ] Update README with HA section and configuration guide
- [ ] Add CHANGELOG entry for v1.11.0 features
- [ ] Update CLI help text for new commands

**Acceptance Criteria:**
- Three working example configurations covering common scenarios
- Documentation explains HA concepts and configuration options
- CLI provides helpful guidance for HA setup

---

### **WP7: Testing & Validation**
**Scope:** Unit tests, template snapshots, integration validation  
**Files:** `src/__tests__/ha-cluster.test.ts`, template tests  
**Timeline:** Day 5

**Tasks:**
- [ ] Create `src/__tests__/ha-cluster.test.ts` test suite
- [ ] Add template snapshot tests for HA scenarios
- [ ] Extend existing test suites for HA integration
- [ ] Add negative tests for conflicting configurations
- [ ] Template generation validation with examples
- [ ] CLI command testing for region validation

**Acceptance Criteria:**
- All existing tests continue to pass (regression prevention)
- New HA features have comprehensive test coverage
- Template generation produces valid ARM JSON for all scenarios

---

### **WP8: Final Integration & Documentation**
**Scope:** Version updates, release preparation, final testing  
**Files:** `package.json`, `src/index.ts`, final docs  
**Timeline:** Day 5-6

**Tasks:**
- [ ] Update version references for v1.11.0
- [ ] Final integration testing with all examples
- [ ] Performance validation (template generation time)
- [ ] Documentation review and polish
- [ ] Prepare commit messages and PR description
- [ ] Final regression test run

**Acceptance Criteria:**
- All work packages integrated and working together
- Documentation complete and accurate
- Ready for merge to develop branch

---

## ðŸŽ¯ Implementation Notes

### **CLI Commands Added:**
- `azmp ha check-region <region>` - Validate PPG + zone support
- `azmp ha examples` - List HA configuration examples
- `azmp ha validate <config>` - Validate HA configuration

### **New Configuration Parameters:**
```json
{
  "highAvailability": {
    "enabled": true,
    "proximityPlacementGroup": true,
    "availabilityZones": ["1", "2", "3"],
    "loadBalancer": {
      "type": "public|internal",
      "sku": "Standard",
      "healthProbe": {
        "protocol": "HTTP|TCP",
        "port": 80,
        "path": "/health"
      }
    },
    "vmss": {
      "instanceCount": 3,
      "maxInstanceCount": 10,
      "autoscale": true
    },
    "healthExtension": {
      "enabled": true,
      "port": 8080,
      "endpoint": "/health"
    }
  },
  "costOptimized": false  // Auto-disabled when HA enabled
}
```

### **Dependencies:**
- Azure regions with PPG + zone support
- Standard Load Balancer SKU for zone scenarios
- Compatible VM sizes for ephemeral disks + zones

---

**Ready for implementation!** Each work package can be tackled independently with clear acceptance criteria.