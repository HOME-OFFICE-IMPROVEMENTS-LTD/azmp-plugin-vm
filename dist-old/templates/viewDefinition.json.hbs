{
  "$schema": "https://schema.management.azure.com/schemas/viewdefinition/0.1.0-preview/ViewDefinition.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "{{name}} - Virtual Machine View Definition",
    "author": "{{publisher}}"
  },
  "authorizations": [
    {
      "principalId": "",
      "roleDefinitionId": ""
    }
  ],
  "locks": [
    {
      "kind": "ReadOnly",
      "exclusions": [
        "managedResourceGroupId"
      ]
    }
  ],
  "viewDefinition": {
    "kind": "Overview",
    "properties": {
      "header": "Virtual Machine Overview",
      "description": "Monitor and manage your {{name}} virtual machine deployment",
      "commands": [
        {
          "displayName": "Start VM",
          "path": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{{vmName}}/start",
          "icon": "Start",
          "confirmation": {
            "title": "Start Virtual Machine",
            "subtitle": "Are you sure you want to start the VM? This will incur compute charges."
          }
        },
        {
          "displayName": "Stop VM",
          "path": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{{vmName}}/powerOff",
          "icon": "Stop",
          "confirmation": {
            "title": "Stop Virtual Machine", 
            "subtitle": "Are you sure you want to stop the VM? This will deallocate the VM and stop compute charges."
          }
        },
        {
          "displayName": "Restart VM",
          "path": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{{vmName}}/restart",
          "icon": "Restart",
          "confirmation": {
            "title": "Restart Virtual Machine",
            "subtitle": "Are you sure you want to restart the VM? This will cause a brief interruption."
          }
        }
      ],
      "essentials": [
        {
          "displayName": "VM Name",
          "value": "{{vmName}}"
        },
        {
          "displayName": "VM Size",
          "value": "{{vmSize}}"
        },
        {
          "displayName": "Operating System",
          "value": "Linux"
        },
        {
          "displayName": "Status",
          "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', '{{vmName}}')).instanceView.statuses[1].displayStatus]"
        },
        {
          "displayName": "Location",
          "value": "[resourceGroup().location]"
        },
        {{#if enableBackup}}
        {
          "displayName": "Backup Enabled",
          "value": "Yes"
        },
        {{/if}}
        {{#if useAvailabilityZones}}
        {
          "displayName": "Availability Zone",
          "value": "Zone {{availabilityZone}}"
        },
        {{/if}}
        {{#if createAvailabilitySet}}
        {
          "displayName": "Availability Set",
          "value": "{{availabilitySetName}}"
        },
        {{/if}}
        {{#if installExtensions}}
        {
          "displayName": "Extensions",
          "value": "Enabled"
        }
        {{/if}}
      ],
      "views": [
        {
          "kind": "Metrics",
          "properties": {
            "displayName": "Performance Metrics",
            "timespan": {
              "relative": {
                "duration": 24,
                "timeUnit": 1
              }
            },
            "metrics": [
              {
                "resourceMetadata": {
                  "id": "[resourceId('Microsoft.Compute/virtualMachines', '{{vmName}}')]"
                },
                "name": "Percentage CPU",
                "aggregationType": 4,
                "namespace": "Microsoft.Compute/virtualMachines",
                "metricVisualization": {
                  "displayName": "CPU Percentage",
                  "color": "#0078D4"
                }
              },
              {
                "resourceMetadata": {
                  "id": "[resourceId('Microsoft.Compute/virtualMachines', '{{vmName}}')]"
                },
                "name": "Available Memory Bytes",
                "aggregationType": 4,
                "namespace": "Microsoft.Compute/virtualMachines",
                "metricVisualization": {
                  "displayName": "Available Memory",
                  "color": "#00BCF2"
                }
              },
              {
                "resourceMetadata": {
                  "id": "[resourceId('Microsoft.Compute/virtualMachines', '{{vmName}}')]"
                },
                "name": "Disk Read Bytes",
                "aggregationType": 1,
                "namespace": "Microsoft.Compute/virtualMachines", 
                "metricVisualization": {
                  "displayName": "Disk Read",
                  "color": "#40E0D0"
                }
              },
              {
                "resourceMetadata": {
                  "id": "[resourceId('Microsoft.Compute/virtualMachines', '{{vmName}}')]"
                },
                "name": "Disk Write Bytes",
                "aggregationType": 1,
                "namespace": "Microsoft.Compute/virtualMachines",
                "metricVisualization": {
                  "displayName": "Disk Write", 
                  "color": "#FF6347"
                }
              }
            ]
          }
        },
        {{#if installExtensions}}
        {{#if installMonitoringExtension}}
        {
          "kind": "MonitorCharts",
          "properties": {
            "displayName": "Advanced Monitoring",
            "timespan": {
              "relative": {
                "duration": 24,
                "timeUnit": 1
              }
            },
            "charts": [
              {
                "displayName": "Log Analytics Data",
                "metrics": [
                  {
                    "resourceMetadata": {
                      "id": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
                    },
                    "name": "Usage",
                    "aggregationType": 4
                  }
                ]
              }
            ]
          }
        },
        {{/if}}
        {{/if}}
        {
          "kind": "ActivityLogBlade",
          "properties": {
            "displayName": "Activity Log",
            "timespan": {
              "relative": {
                "duration": 24,
                "timeUnit": 1
              }
            }
          }
        },
        {{#if enableBackup}}
        {
          "kind": "CustomBlade",
          "properties": {
            "displayName": "Backup Status",
            "description": "View backup job status and restore points",
            "bladeReference": {
              "name": "BackupItemBlade",
              "extension": "Microsoft_Azure_RecoveryServices",
              "parameters": {
                "resourceId": "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems', variables('backupVaultName'), 'Azure', concat('iaasvmcontainer;iaasvmcontainerv2;', resourceGroup().name, ';', '{{vmName}}'), concat('vm;iaasvmcontainerv2;', resourceGroup().name, ';', '{{vmName}}'))]"
              }
            }
          }
        }
        {{/if}}
      ]
    }
  }
}